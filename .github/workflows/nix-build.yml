name: Nix Build & Validation

# Demonstrates NixOS expertise and reproducible build engineering
# Purpose: Validate Nix packaging, flake structure, and cross-platform builds

on:
  push:
    branches: [main, develop]
    paths:
      - 'flake.nix'
      - 'flake.lock'
      - 'src/**'
      - 'package.json'
      - 'package-lock.json'
  pull_request:
    branches: [main, develop]
  workflow_dispatch:

env:
  NIX_VERSION: '2.21.0'

jobs:
  # ===================================================================
  # Nix Flake Validation
  # Purpose: Ensure flake structure is valid before attempting builds
  # ===================================================================

  flake-check:
    name: Nix Flake Check
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Nix
        uses: cachix/install-nix-action@v25
        with:
          nix_path: nixpkgs=channel:nixos-unstable
          extra_nix_config: |
            experimental-features = nix-command flakes
            substituters = https://cache.nixos.org/
            trusted-public-keys = cache.nixos.org-1:6NCHdD59X431o0gWypbMrAURkbJ16ZPMQFGspcDShjY=

      # Demonstrates understanding of Nix flake structure
      - name: Validate Flake Structure
        run: |
          nix flake metadata --json | jq . > flake-metadata.json
          cat flake-metadata.json

      - name: Check Flake Outputs
        run: |
          echo "## Flake Outputs" > nix-report.md
          echo "\`\`\`json" >> nix-report.md
          nix flake show --json | jq . >> nix-report.md
          echo "\`\`\`" >> nix-report.md

      # Critical: Ensure flake.lock is up-to-date
      - name: Verify Flake Lock
        run: |
          nix flake lock --no-update-lock-file
          git diff --exit-code flake.lock || {
            echo "âŒ flake.lock is out of sync! Run 'nix flake update' locally."
            exit 1
          }

      - name: Upload flake metadata
        uses: actions/upload-artifact@v4
        with:
          name: flake-metadata
          path: |
            flake-metadata.json
            nix-report.md
          retention-days: 30

  # ===================================================================
  # Nix Package Build (Multi-System)
  # Purpose: Prove reproducible builds across x86_64-linux and aarch64-linux
  # ===================================================================

  build-package:
    name: Build Nix Package (${{ matrix.system }})
    runs-on: ${{ matrix.runner }}
    needs: [flake-check]
    strategy:
      fail-fast: false
      matrix:
        include:
          - system: x86_64-linux
            runner: ubuntu-latest
          # - system: aarch64-linux
          #   runner: ubuntu-latest-arm64  # Requires ARM runners
          - system: x86_64-darwin
            runner: macos-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Free up disk space (Linux)
        if: runner.os == 'Linux'
        run: |
          sudo rm -rf /usr/share/dotnet /opt/ghc /usr/local/share/boost
          sudo apt-get clean

      - name: Install Nix
        uses: cachix/install-nix-action@v25
        with:
          nix_path: nixpkgs=channel:nixos-unstable
          extra_nix_config: |
            experimental-features = nix-command flakes
            substituters = https://cache.nixos.org/
            trusted-public-keys = cache.nixos.org-1:6NCHdD59X431o0gWypbMrAURkbJ16ZPMQFGspcDShjY=
            max-jobs = auto
            cores = 0

      # Cachix - binary cache for faster builds
      - name: Configure Cachix
        uses: cachix/cachix-action@v14
        continue-on-error: true
        with:
          name: securellm-mcp
          authToken: '${{ secrets.CACHIX_AUTH_TOKEN }}'
          skipPush: ${{ github.event_name == 'pull_request' }}

      # Demonstrates Nix build expertise
      - name: Build Default Package
        run: |
          nix build .#default \
            --print-build-logs \
            --show-trace \
            --fallback

      - name: Test Package Installation
        run: |
          ls -lh result/
          ls -lh result/bin/
          file result/bin/securellm-mcp

      - name: Validate Wrapper Scripts
        run: |
          # Check that wrapper scripts are executable
          test -x result/bin/securellm-mcp || exit 1
          test -x result/bin/securellm-mcp-dev || exit 1

          # Verify shebangs
          head -1 result/bin/securellm-mcp | grep -q "bash" || exit 1

      - name: Check Build Reproducibility
        if: matrix.system == 'x86_64-linux'
        run: |
          # Build twice and compare hashes
          hash1=$(nix build .#default --no-link --print-out-paths)
          nix store delete $hash1 || true
          hash2=$(nix build .#default --no-link --print-out-paths --rebuild)

          if [ "$hash1" = "$hash2" ]; then
            echo "âœ… Build is reproducible: $hash1"
          else
            echo "âš ï¸  Build hashes differ (may be non-deterministic)"
            echo "First:  $hash1"
            echo "Second: $hash2"
          fi

      - name: Generate Build Report
        run: |
          echo "## Nix Build Report (${{ matrix.system }})" > build-report-${{ matrix.system }}.md
          echo "" >> build-report-${{ matrix.system }}.md
          echo "### Build Details" >> build-report-${{ matrix.system }}.md
          echo "\`\`\`" >> build-report-${{ matrix.system }}.md
          nix path-info result --json | jq . >> build-report-${{ matrix.system }}.md
          echo "\`\`\`" >> build-report-${{ matrix.system }}.md
          echo "" >> build-report-${{ matrix.system }}.md
          echo "### Closure Size" >> build-report-${{ matrix.system }}.md
          nix path-info -rsSh result >> build-report-${{ matrix.system }}.md

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: nix-build-${{ matrix.system }}
          path: |
            result/
            build-report-${{ matrix.system }}.md
          retention-days: 7

  # ===================================================================
  # Development Shell Validation
  # Purpose: Ensure devShell works for contributors
  # ===================================================================

  test-dev-shell:
    name: Test Development Shell
    runs-on: ubuntu-latest
    needs: [flake-check]

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Nix
        uses: cachix/install-nix-action@v25
        with:
          nix_path: nixpkgs=channel:nixos-unstable
          extra_nix_config: |
            experimental-features = nix-command flakes

      - name: Enter Dev Shell and Build
        run: |
          nix develop --command bash -c "
            echo '=== Dev Shell Environment ==='
            node --version
            npm --version
            tsc --version
            echo ''
            echo '=== Installing Dependencies ==='
            npm ci
            echo ''
            echo '=== Building Project ==='
            npm run build
            echo ''
            echo '=== Running Linter ==='
            npm run lint
          "

      - name: Validate Dev Environment
        run: |
          nix develop --command bash -c "
            echo '## Development Environment Validation' > dev-env-report.md
            echo '' >> dev-env-report.md
            echo '### Tool Versions' >> dev-env-report.md
            echo '\`\`\`' >> dev-env-report.md
            echo 'Node.js: '$(node --version) >> dev-env-report.md
            echo 'npm: '$(npm --version) >> dev-env-report.md
            echo 'TypeScript: '$(tsc --version) >> dev-env-report.md
            echo 'SQLite: '$(sqlite3 --version) >> dev-env-report.md
            echo '\`\`\`' >> dev-env-report.md
          "

      - name: Upload dev shell report
        uses: actions/upload-artifact@v4
        with:
          name: dev-shell-validation
          path: dev-env-report.md
          retention-days: 30

  # ===================================================================
  # Nix Flake Update (Automated)
  # Purpose: Keep dependencies up-to-date with automated PRs
  # ===================================================================

  flake-update:
    name: Update Flake Dependencies
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Install Nix
        uses: cachix/install-nix-action@v25
        with:
          nix_path: nixpkgs=channel:nixos-unstable
          extra_nix_config: |
            experimental-features = nix-command flakes

      - name: Update Flake Inputs
        run: |
          nix flake update --commit-lock-file || true

      - name: Verify Build Still Works
        run: |
          nix build .#default --print-build-logs

      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: 'chore(nix): update flake inputs'
          title: 'ðŸ”„ Update Nix Flake Dependencies'
          body: |
            ## Automated Flake Update

            This PR updates the Nix flake inputs to their latest versions.

            ### Changed Inputs
            - nixpkgs: Updated to latest unstable
            - flake-utils: Updated to latest

            ### Validation
            - âœ… Build still succeeds
            - âœ… Development shell validated

            **Generated by automated flake update workflow**
          branch: automated-flake-updates
          delete-branch: true
          labels: |
            dependencies
            nix
            automated

  # ===================================================================
  # Nix Store Optimization Analysis
  # Purpose: Demonstrate understanding of Nix closure optimization
  # ===================================================================

  analyze-closure:
    name: Analyze Nix Closure
    runs-on: ubuntu-latest
    needs: [build-package]

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Nix
        uses: cachix/install-nix-action@v25
        with:
          nix_path: nixpkgs=channel:nixos-unstable
          extra_nix_config: |
            experimental-features = nix-command flakes

      - name: Build Package
        run: nix build .#default

      - name: Analyze Closure Size
        run: |
          echo "## Nix Closure Analysis" > closure-report.md
          echo "" >> closure-report.md
          echo "### Total Closure Size" >> closure-report.md
          echo "\`\`\`" >> closure-report.md
          nix path-info -rsSh result >> closure-report.md
          echo "\`\`\`" >> closure-report.md
          echo "" >> closure-report.md
          echo "### Largest Dependencies" >> closure-report.md
          echo "\`\`\`" >> closure-report.md
          nix path-info -rs result | xargs nix path-info -sh | sort -k2 -h | tail -20 >> closure-report.md
          echo "\`\`\`" >> closure-report.md
          echo "" >> closure-report.md
          echo "### Dependency Graph" >> closure-report.md
          nix-store --query --graph result > closure-graph.dot || true

      - name: Identify Optimization Opportunities
        run: |
          echo "## Optimization Recommendations" >> closure-report.md
          echo "" >> closure-report.md
          echo "- Consider splitting runtime/build dependencies" >> closure-report.md
          echo "- Evaluate if all transitive deps are necessary" >> closure-report.md
          echo "- Use \`removeReferencesTo\` for build-only dependencies" >> closure-report.md

      - name: Upload closure analysis
        uses: actions/upload-artifact@v4
        with:
          name: closure-analysis
          path: |
            closure-report.md
            closure-graph.dot
          retention-days: 90
