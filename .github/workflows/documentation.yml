name: Documentation Generation

# Demonstrates commitment to comprehensive documentation and developer experience
# Purpose: Auto-generate API docs, complexity reports, and deployment guides

on:
  push:
    branches: [main, develop]
    paths:
      - 'src/**'
      - 'docs/**'
      - 'README.md'
  pull_request:
    branches: [main]
  workflow_dispatch:

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  # ===================================================================
  # TypeScript API Documentation Generation
  # Purpose: Auto-generate API docs from TSDoc comments
  # ===================================================================

  generate-api-docs:
    name: Generate TypeScript API Documentation
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22.x'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      # TypeDoc - professional TypeScript API documentation
      - name: Generate API Documentation
        run: |
          npx typedoc \
            --out docs/api \
            --entryPoints src/index.ts \
            --entryPointStrategy expand \
            --exclude "**/*.test.ts" \
            --exclude "**/*.spec.ts" \
            --theme default \
            --name "SecureLLM MCP Server API" \
            --readme README.md \
            --includeVersion

      - name: Upload API docs artifact
        uses: actions/upload-artifact@v4
        with:
          name: api-documentation
          path: docs/api/
          retention-days: 30

  # ===================================================================
  # Architecture Visualization
  # Purpose: Generate visual dependency graphs and complexity maps
  # ===================================================================

  generate-architecture-diagrams:
    name: Generate Architecture Diagrams
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22.x'

      - name: Install dependencies
        run: npm ci

      # Dependency Cruiser - module dependency visualization
      - name: Generate Dependency Graph
        run: |
          npx dependency-cruiser \
            --output-type dot \
            src | dot -T svg > docs/diagrams/dependency-graph.svg || true

      # Madge - circular dependency detection
      - name: Analyze Circular Dependencies
        run: |
          npx madge --circular --extensions ts src > docs/reports/circular-deps.txt || echo "No circular dependencies found"
          npx madge --image docs/diagrams/module-tree.svg src || true

      - name: Generate Module Statistics
        run: |
          echo "## Module Statistics" > docs/reports/module-stats.md
          echo "" >> docs/reports/module-stats.md
          echo "### File Count by Directory" >> docs/reports/module-stats.md
          echo "\`\`\`" >> docs/reports/module-stats.md
          find src -type d -not -path "*/node_modules/*" | while read dir; do
            count=$(find "$dir" -maxdepth 1 -name "*.ts" | wc -l)
            if [ $count -gt 0 ]; then
              echo "$dir: $count files"
            fi
          done >> docs/reports/module-stats.md
          echo "\`\`\`" >> docs/reports/module-stats.md

      - name: Upload architecture artifacts
        uses: actions/upload-artifact@v4
        with:
          name: architecture-diagrams
          path: |
            docs/diagrams/
            docs/reports/
          retention-days: 30

  # ===================================================================
  # Code Metrics & Complexity Analysis
  # Purpose: Generate maintainability and complexity reports
  # ===================================================================

  generate-metrics:
    name: Generate Code Metrics
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22.x'

      - name: Install dependencies
        run: npm ci

      # ESLint complexity plugin
      - name: Calculate Cyclomatic Complexity
        run: |
          echo "## Cyclomatic Complexity Report" > docs/reports/complexity.md
          echo "" >> docs/reports/complexity.md
          echo "Analyzing codebase complexity..." >> docs/reports/complexity.md
          npx eslint src --format json > eslint-complexity.json || true

      # SLOCCount equivalent
      - name: Generate LoC Metrics
        run: |
          echo "## Lines of Code Analysis" > docs/reports/loc-metrics.md
          echo "" >> docs/reports/loc-metrics.md
          echo "\`\`\`" >> docs/reports/loc-metrics.md
          echo "Total TypeScript Files: $(find src -name '*.ts' | wc -l)" >> docs/reports/loc-metrics.md
          echo "Total Lines: $(find src -name '*.ts' -exec wc -l {} + | tail -1 | awk '{print $1}')" >> docs/reports/loc-metrics.md
          echo "Average File Size: $(($(find src -name '*.ts' -exec wc -l {} + | tail -1 | awk '{print $1}') / $(find src -name '*.ts' | wc -l))) lines" >> docs/reports/loc-metrics.md
          echo "" >> docs/reports/loc-metrics.md
          echo "Breakdown by subsystem:" >> docs/reports/loc-metrics.md
          for subsystem in tools middleware reasoning knowledge types; do
            lines=$(find src/$subsystem -name '*.ts' -exec wc -l {} + 2>/dev/null | tail -1 | awk '{print $1}' || echo 0)
            files=$(find src/$subsystem -name '*.ts' 2>/dev/null | wc -l || echo 0)
            if [ $files -gt 0 ]; then
              echo "  $subsystem: $lines lines across $files files" >> docs/reports/loc-metrics.md
            fi
          done
          echo "\`\`\`" >> docs/reports/loc-metrics.md

      - name: Upload metrics artifacts
        uses: actions/upload-artifact@v4
        with:
          name: code-metrics
          path: |
            docs/reports/
            eslint-complexity.json
          retention-days: 90

  # ===================================================================
  # Changelog Generation
  # Purpose: Automated changelog from conventional commits
  # ===================================================================

  generate-changelog:
    name: Generate Changelog
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for changelog

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22.x'

      # Conventional Changelog
      - name: Generate Changelog
        run: |
          npx conventional-changelog-cli -p angular -i CHANGELOG.md -s -r 0

      - name: Commit Changelog
        if: github.event_name == 'push'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add CHANGELOG.md
          git commit -m "docs: update CHANGELOG [skip ci]" || echo "No changes to commit"
          git push

  # ===================================================================
  # Deploy Documentation to GitHub Pages
  # Purpose: Host documentation on GitHub Pages for easy access
  # ===================================================================

  deploy-docs:
    name: Deploy to GitHub Pages
    runs-on: ubuntu-latest
    needs: [generate-api-docs, generate-architecture-diagrams, generate-metrics]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'

    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download API docs
        uses: actions/download-artifact@v4
        with:
          name: api-documentation
          path: _site/api

      - name: Download architecture diagrams
        uses: actions/download-artifact@v4
        with:
          name: architecture-diagrams
          path: _site/architecture

      - name: Download metrics
        uses: actions/download-artifact@v4
        with:
          name: code-metrics
          path: _site/metrics

      - name: Copy documentation files
        run: |
          mkdir -p _site/docs
          cp -r docs/* _site/docs/ || true
          cp README.md _site/index.md

      - name: Create documentation index
        run: |
          cat > _site/index.html <<'EOF'
          <!DOCTYPE html>
          <html lang="en">
          <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title>SecureLLM MCP Server - Documentation</title>
            <style>
              body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; margin: 0; padding: 40px; background: #0d1117; color: #c9d1d9; }
              .container { max-width: 1200px; margin: 0 auto; }
              h1 { color: #58a6ff; border-bottom: 1px solid #30363d; padding-bottom: 10px; }
              .card { background: #161b22; border: 1px solid #30363d; border-radius: 6px; padding: 20px; margin: 20px 0; }
              .card h2 { color: #58a6ff; margin-top: 0; }
              a { color: #58a6ff; text-decoration: none; }
              a:hover { text-decoration: underline; }
              .badge { display: inline-block; background: #1f6feb; color: white; padding: 4px 8px; border-radius: 4px; font-size: 12px; margin: 4px; }
            </style>
          </head>
          <body>
            <div class="container">
              <h1>ğŸ”Œ SecureLLM MCP Server Documentation</h1>

              <div class="card">
                <h2>ğŸ“š API Documentation</h2>
                <p>Comprehensive TypeScript API documentation generated from TSDoc comments.</p>
                <a href="api/index.html">View API Documentation â†’</a>
              </div>

              <div class="card">
                <h2>ğŸ—ï¸ Architecture</h2>
                <p>Module dependency graphs, architecture diagrams, and system design documentation.</p>
                <a href="architecture/">View Architecture Documentation â†’</a>
              </div>

              <div class="card">
                <h2>ğŸ“Š Code Metrics</h2>
                <p>Complexity analysis, LoC statistics, and maintainability reports.</p>
                <a href="metrics/">View Code Metrics â†’</a>
              </div>

              <div class="card">
                <h2>ğŸ“– Guides & Documentation</h2>
                <p>Implementation guides, architecture decision records, and technical documentation.</p>
                <a href="docs/">View Documentation â†’</a>
              </div>

              <div class="card">
                <h2>ğŸ”— Quick Links</h2>
                <span class="badge">GitHub Repository</span>
                <span class="badge">Issue Tracker</span>
                <span class="badge">Contributing Guide</span>
                <span class="badge">Changelog</span>
              </div>
            </div>
          </body>
          </html>
          EOF

      - name: Setup Pages
        uses: actions/configure-pages@v4

      - name: Upload Pages artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: _site

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

  # ===================================================================
  # Documentation Quality Checks
  # Purpose: Validate documentation completeness and quality
  # ===================================================================

  validate-docs:
    name: Validate Documentation
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Check for broken links
        run: |
          npx markdown-link-check README.md --config .github/markdown-link-check.json || true
          find docs -name "*.md" -exec npx markdown-link-check {} \; || true

      - name: Validate Markdown formatting
        run: |
          npx markdownlint-cli2 "**/*.md" "#node_modules" || true

      - name: Check for TODO/FIXME comments
        run: |
          echo "## Outstanding TODOs" > docs/reports/todos.md
          grep -r "TODO\|FIXME" src --include="*.ts" >> docs/reports/todos.md || echo "No TODOs found!"

      - name: Upload validation results
        uses: actions/upload-artifact@v4
        with:
          name: doc-validation
          path: docs/reports/todos.md
          retention-days: 30
